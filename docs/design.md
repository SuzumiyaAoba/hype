# 新言語設計メモ

- **型システム**: 静的型付け。構造的部分型（幅・深さ）、関数は反変/共変＋効果注釈。依存型は実行時消去可能な範囲に限定し、長さ付き配列など値依存を表現。型クラスでオーバーロードとインスタンス解決を提供（`Eq`, `Ord`, `Show`, `Functor`, `Monad` など）。
- **効果システム**: アルジェブラ的エフェクト＋ハンドラを採用し、IO/Async/State/Exception などをエフェクト行（row）で表現。サブエフェクト関係を定義し、純粋関数と効果関数を型で区別。エフェクト多相で汎用関数を記述し、`handle` 構文で捕捉・再解釈。JS出力時は `async/await` やPromise合成へ落とし込み、不要エフェクトは消去最適化。
- **推論と検証**: H-M拡張の型推論。依存型は簡易検証中心で、必要に応じ証明用 term を分離。`--no-typecheck` フラグで型検証をスキップし、AST→JSを直接生成（型情報をコメント/メタデータで残すオプションあり）。
- **所有権とリソース安全**: Rust系の所有権/借用モデルとリージョン/線形型を導入し、ファイルハンドルやメモリ等のリソース解放と並行安全を静的保証。エフェクト行と組み合わせ、リソース操作を型で制御。
- **能力ベース権限制御**: IO/FS/ネットワーク等を `capability` として型で明示し、最小権限で関数を設計。権限の委譲/昇格は型クラスやエフェクト境界で表現。
- **コンパイル時多態**: 多相リテラル（数値/文字列/配列）を型クラスで解決し、限定的な型レベル計算を許可。実行時コストなしで最適な表現を選択できるよう最適化パスと連携。
- **並行・並列プリミティブ**: `async` に加え、`spawn`、タスクスコープによる構造化並行、キャンセル伝播を標準化。リソース確保/解放と組み合わせ、キャンセル安全性を型で担保。
- **安全境界の強化**: `safe/unsafe` 二層モデルを明確化し、FFIやエフェクト境界、能力昇格時の不変条件を型で要求。`unsafe effect` のような境界宣言でレビュー対象を限定。
- **最適化ヒント**: `@inline`/`@noinline`、`@pure`、値/参照表現のヒントをアノテーションで付与し、IR最適化と連携。JITと相性の悪いパターンを避けるための禁止アノテーションも検討。
- **ビルド/ツール統合**: `fmt + lint + typecheck + test + bench` を一括実行するコマンド、ビルドキャッシュ、インクリメンタル型チェックを標準提供。LSPと統合し、エフェクト/所有権の診断をIDEに反映。
- **並行モデル**: アクター/チャネル（CSP）/STM のいずれかを第一級にし、エフェクト行と整合を取る。構造化並行＋キャンセル安全を型で保証し、監査可能なタスクスコープを提供。
- **リソース解放フック**: `using` 構文（try/finally 展開）と標準 `Disposable` プロトコルを用意し、ブラウザ/Node 双方で決定的解放を表現。所有権/線形型と接続して二重解放を防止。
- **非同期例外と監査ログ**: `async` 例外伝播とキャンセルの型付けルールを定め、監査ログ/トレースID付与の標準ライブラリを提供。キャンセル伝播時のクリーンアップを型で要求。
- **パターンマッチ拡張**: ガード、ビュー、エフェクトパターンに対応し、網羅性チェックを型で警告。依存型と組み合わせてより精密な分岐を記述可能に。
- **安全なリフレクション/マクロ**: 型付きマクロと staged IR（quote/splice）を提供し、安全側に寄せたコード生成を可能に。型検証スキップモードでもマクロは安全に評価されるよう制限。
- **DevEx強化**: プロパティテスト/スナップショットテスト/`doc-test`/簡易ベンチを標準化し、`perf-test` を同梱。エディタで型・エフェクト・所有権のクイックフィックスを提示。
- **インクリメンタル推論**: 型・エフェクトの部分推論を行い、IDEで即時フィードバックを返すインクリメンタル検証パイプラインを提供。
- **リファインメント型（軽量）**: SMT を用いた範囲・不変条件の軽量リファインメント型をオプション採用。依存型より記述負荷を抑え、コンパイル時に検証。
- **設計契約**: `requires/ensures/invariant` 契約をエフェクト行と併用可能にし、コンパイル時チェックとJSではアサート出力のモードを用意。
- **データアクセスDSL**: ビュー/レンズ/プリズムを標準ライブラリで提供し、JS出力時に束縛やアロケーションを削減する最適化を行う。
- **境界性能モード**: `--profile` で IR 段階のコスト注釈を出力、`--budget` で関数単位のコスト予算違反を警告する仕組みを提供。
- **ロケール/国際化安全**: 日付/数値/文字列正規化を型・エフェクトで扱い、`Intl` を活用する。ロケール非依存モードも選択可。
- **バイナリ/FFI強化**: TypedArray/ArrayBuffer を一次データ表現とする型を標準化し、JS側でもゼロコピーを目指す。
- **安全なプラグイン機構**: コンパイラ拡張（最適化や警告追加）を安全プラグインとして登録するAPIを提供。`unsafe` プラグインは明示的に隔離。
- **ドキュメント生成**: ソースコメントからリファレンスを自動生成し、`doc-test` と連動。型/エフェクト/能力のシグネチャ表を自動出力。
- **HTMLライク構文（JSX風）**: 型付きテンプレートとしてタグ/属性/子要素を構文に組み込み、VNode/リアルDOM/SSR向けの複数バックエンドにトランスパイル。属性は型クラスで検証し、イベントハンドラはエフェクト行で制約。サーバ専用属性や危険な挿入（innerHTML）は `unsafe` 境界で明示。
- **文法拡張方針**: 式指向ブロック（現状の最小サブセットでは `match` のみで分岐し、`if` は未採用）、先行宣言可能な演算子優先度/結合性テーブル、記号/Unicode/ASCII 別名の両立、`using/handle` などリソース・エフェクト構文を第一級化。パターンはガード/ビュー/エフェクトパターンを含み、`effect` 宣言と `handle` のスコープが明示される構文を採用。
- **型注釈と推論**: let の型注釈と関数の戻り値注釈は省略可。Number/String/Bool の範囲で単純な（型変数なしの）推論を行い、引数型は明示が必要。
- **型推論デバッグ**: 環境変数 `HYPE_INFER_LOG=<path>` で推論ログ＋推論済みソースをファイル出力、`HYPE_INFER_ANNOTATED_OUT=<path>` で推論済みソースのみを出力できる。
- **時間/スケジュール効果**: `sleep`/タイマー/デバウンス/スロットルをエフェクト行で型付けし、キャンセル安全を保証。
- **テレメトリ統合**: ロギング/メトリクス/トレースを型クラスで抽象化し、`capability` で送信先を制約。ビルドフラグで挿入/除去を切替。
- **エラーブジェクションポリシー**: `async` 未処理拒否を静的検出し、`Result`/`Option` への強制マッピングを選択できるコンパイラオプションを提供。
- **デバッグ挿入プリミティブ**: `dbg`/`trace` をエフェクト安全に挿入し、最適化時には自動除去できる仕組みを用意。
- **リファクタ安全識別子**: シンボルベースの名前解決（バインドID）を採用し、リネームや演算子名変更をLSP連携で安全に実施。
- **ターゲット最適化プリセット**: ブラウザ/Node/クラウドワーカー向けに `--opt-level`/polyfill/GCフレンドリーな出力戦略をプリセットで提供。
- **クロスコンパイル/ABI**: WebAssembly（WASI/ブラウザ）や Deno/Cloudflare Workers への直接出力モードを提供し、JSとのFFIを最小化したサンドボックス実行をサポート。
- **低遅延モード**: GC圧を抑えるリージョン/線形最適化と、イベントループ優先度を制御するヒント/APIを用意し、リアルタイム志向の構成をサポート。
- **セキュアテンプレート**: JSX風構文と連動し、コンテキスト感知エスケープをデフォルト化。`unsafe` 挿入は型で明示し、静的警告を出す。
- **証明義務分離**: 依存型/リファインメントの証明部を分離し、`--with-proofs`/`--without-proofs` でビルドプロファイルを選択可能にする。
- **モジュール可視性/安定性属性**: `public/internal/experimental` などの可視性と、stable/unstable の安定性をAPI署名に刻み、破壊的変更を検知。
- **並列ビルドとキャッシュ共有**: CIとローカルでビルドキャッシュを共有し、インクリメンタル型・エフェクト検証の差分キャッシュを標準化。
- **並列IR最適化パイプライン**: SSA/ANF など複数IRを段階的に用い、エフェクト・所有権情報を保持したまま並列最適化。オプションでIR段の可視化を提供。
- **決定性/再現性フラグ**: 乱数/時刻/IOを固定するデターミニスティックビルドモードと、トレース記録・再生機能を提供。
- **ハードウェアアクセラレーション**: WebGPU/WebGL/Simd/Atomics への安全なバインディングを用意し、TypedArray/SharedArrayBuffer を活かした並列計算プリミティブを標準化。
- **コード署名/サプライチェーン安全**: パッケージ署名と検証、API署名（型/エフェクト/能力）を含むロックファイル検証を標準化し、外部JSライブラリへの依存を前提としない形でサプライチェーンを守る。
- **モジュール/パッケージ管理**: セマンティックバージョニングとロックファイルを採用し、公開APIの型/エフェクト/能力署名を含むチェックサムで再現性を保証。
- **プロトコル/セッション型**: WS/HTTP/IPC 等の通信手順をセッション型で表現し、並行モデル・エフェクト行と統合してストリーム/チャネル通信の安全性を静的保証。
- **スキーマ連携**: JSON/GraphQL/Protobuf/DB スキーマを型としてインポートし、エフェクト境界に自動付与。生成コードと実スキーマのドリフトを標準機能で検知。
- **ホットリロード/REPL**: インクリメンタルコンパイル＋ウォッチでホットリロードし、型/エフェクト/所有権エラーを即時提示する対話環境を提供。
- **リソース予算の静的上限**: メモリ/FD/並列タスク数などの上限をリファインメントや契約で指定し、超過をビルド警告またはエラーにする。
- **不変データ構造**: 永続ベクタ/マップ/セットを標準提供し、JS出力時に構造共有を活かした低アロケーション実装を生成。
- **整合性ポリシー**:
  - 並行モデル優先度を定め、アクター/チャネル/STM の併用時はエフェクト行で合成規則を明記。
  - `handle` スコープとタスクスコープの入れ子・キャンセル時の cleanup 担当を仕様化。
  - `safe/unsafe` とマクロ/staged IR の伝播ルールを定義し、`unsafe effect` の拡散範囲を可視化。
  - 型クラス解決のコヒーレンス/オーバーラップ/孤児規則を固定し、多相リテラル解決順序を明文化。
  - FFI `external` は capability とエフェクト指定を必須化し、`unsafe` 境界を明示。
  - `--no-typecheck` 時は効果/所有権/能力の静的保証を無効化し、警告を出す。必要に応じランタイムチェックを挿入するデバッグモードを提供。
  - テスト群（property/snapshot/doc/perf）はモック capability と擬似リソースを用意し、所有権・効果制約を崩さずに検証できるようにする。
  - リファインメント型と依存型の検証順序を「通常型→リファインメント→依存」と段階化し、エラー報告を安定化。
  - 演算子宣言・`using/handle`・エフェクトパターンに対するフォーマッタ/LSPルールを定義し、自動整形と補完を一貫させる。
  - `--no-typecheck` 時に効果/所有権/能力/リファインメント/契約が無効になる旨を明示し、デフォルトでランタイムチェックを挿入するデバッグ設定を提供。
- **関数型指向**: 代数的データ型、パターンマッチ、イミュータブル優先。ラムダはカリー化・部分適用。モジュールは名前空間＋型クラスインスタンスのオーファン対策ルールを設計。
- **記号関数名**: `(+), (∘), (>>>), (<=?)` などを関数名として許可。中置/前置/後置は宣言で優先度・結合性を設定。UnicodeとASCIIの双方で記述可能（ASCIIの別名も用意）。
- **最適化とIR**: 中間IRを定義し、デッドコード除去、インライン展開、CSE、融合（例: map/sum）、部分評価。ターゲット（Node/ブラウザ）ごとにJS出力を最適化し、必要に応じてpolyfillを切替。
- **FFI/JS相互運用**: 外部宣言でJS関数に型シグネチャを付与。`unsafe` ブロックで境界を明示し、型チェック緩和を許可。
- **エラー処理**: 総合例外型（`Result`, `Option`）を標準化。例外はFFI境界のみ許容し、内部はモナド/エフェクトで扱う。
- **ツールチェーン**: LSP、フォーマッタ、型チェッカ、`--no-typecheck` と `--opt-level` で最適化段階を選択。テストは型安全モードを推奨。
- **次ステップ案**: 1) 最小構文サンプルとJSトランスパイル例を用意 2) IRと型消去戦略のスケッチ 3) 記号演算子の優先度テーブルと宣言構文のドラフト
